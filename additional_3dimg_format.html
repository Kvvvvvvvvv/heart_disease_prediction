<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiovascular Risk Visualization System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c2e 0%, #1a1a3e 100%);
            color: #e0e0ff;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        #viewer-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #viewer {
            width: 100%;
            height: 100%;
        }

        #control-panel {
            width: 400px;
            background: rgba(10, 10, 30, 0.95);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(100, 150, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #4fc3f7;
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }

        .header .subtitle {
            color: #bb86fc;
            font-size: 14px;
            opacity: 0.9;
        }

        .risk-score-container {
            background: linear-gradient(135deg, rgba(20, 20, 50, 0.9), rgba(30, 30, 70, 0.9));
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #2962ff;
            box-shadow: 0 0 20px rgba(41, 98, 255, 0.3);
            text-align: center;
        }

        .risk-label {
            font-size: 14px;
            color: #b0b0ff;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .risk-value {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .risk-level {
            font-size: 16px;
            font-weight: 600;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }

        .section {
            background: rgba(20, 20, 40, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(100, 150, 255, 0.2);
        }

        .section-title {
            color: #4fc3f7;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: "‚Ä¢";
            color: #bb86fc;
            font-size: 24px;
        }

        .layer-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .layer-btn {
            background: rgba(40, 40, 80, 0.8);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 12px;
            color: #e0e0ff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .layer-btn:hover {
            background: rgba(60, 60, 120, 0.8);
            transform: translateY(-2px);
        }

        .layer-btn.active {
            background: rgba(79, 195, 247, 0.2);
            border-color: #4fc3f7;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
        }

        .slider-group {
            margin: 15px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .slider-value {
            color: #4fc3f7;
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(100, 150, 255, 0.2);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4fc3f7;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.8);
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(10, 10, 30, 0.9);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            border: 1px solid rgba(100, 150, 255, 0.3);
            backdrop-filter: blur(5px);
            font-size: 14px;
            line-height: 1.5;
        }

        .info-panel h3 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .hover-tooltip {
            position: absolute;
            background: rgba(10, 10, 30, 0.95);
            border: 1px solid #4fc3f7;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            max-width: 250px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.3);
        }

        .legend {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .explanation {
            font-size: 13px;
            color: #b0b0ff;
            margin-top: 15px;
            line-height: 1.4;
            background: rgba(30, 30, 60, 0.5);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #bb86fc;
        }

        @media (max-width: 1200px) {
            #container {
                flex-direction: column;
            }
            #control-panel {
                width: 100%;
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="viewer-container">
            <div id="viewer"></div>
            <div id="hover-tooltip" class="hover-tooltip" style="display: none;"></div>
            <div class="info-panel">
                <h3>ü´Ä Interactive Heart Model</h3>
                <p>‚Ä¢ Click & drag to rotate</p>
                <p>‚Ä¢ Scroll to zoom</p>
                <p>‚Ä¢ Hover over features for details</p>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ef5350;"></div>
                        <span>High Risk</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff9800;"></div>
                        <span>Moderate</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4caf50;"></div>
                        <span>Low Risk</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="control-panel">
            <div class="header">
                <h1>Cardiovascular Risk Visualization</h1>
                <div class="subtitle">Multi-Layer Physiological Stress Analysis</div>
            </div>

            <div class="risk-score-container">
                <div class="risk-label">Overall Risk Score</div>
                <div id="risk-value" class="risk-value">0.42</div>
                <div id="risk-level" class="risk-level" style="background: rgba(255, 152, 0, 0.2); color: #ff9800;">
                    MODERATE RISK
                </div>
            </div>

            <div class="section">
                <div class="section-title">üé® Visualization Layers</div>
                <div class="layer-controls">
                    <button class="layer-btn active" data-layer="global">üü• Global Risk</button>
                    <button class="layer-btn" data-layer="chamber">ü´Ä Chamber Function</button>
                    <button class="layer-btn" data-layer="coronary">ü©∏ Coronary Vasculature</button>
                    <button class="layer-btn" data-layer="electrical">‚ö° Electrical System</button>
                    <button class="layer-btn" data-layer="biochemical">üß¨ Biochemical Stress</button>
                    <button class="layer-btn" data-layer="all">üëÅÔ∏è All Layers</button>
                </div>
                <div class="explanation" id="layer-explanation">
                    Global Risk Layer: Shows overall cardiovascular stress level through heart coloration and pulsation patterns.
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìä Patient Data Input</div>
                
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Age: <span id="age-val" class="slider-value">55</span> years</span>
                        <span>Risk: <span id="age-risk" class="slider-value">Medium</span></span>
                    </div>
                    <input type="range" id="age" min="20" max="90" value="55" step="1">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>Systolic BP: <span id="bp-val" class="slider-value">135</span> mmHg</span>
                        <span>Risk: <span id="bp-risk" class="slider-value">High</span></span>
                    </div>
                    <input type="range" id="bp" min="90" max="200" value="135" step="1">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>LDL Cholesterol: <span id="ldl-val" class="slider-value">160</span> mg/dL</span>
                        <span>Risk: <span id="ldl-risk" class="slider-value">High</span></span>
                    </div>
                    <input type="range" id="ldl" min="50" max="300" value="160" step="5">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>Ejection Fraction: <span id="ef-val" class="slider-value">55</span>%</span>
                        <span>Risk: <span id="ef-risk" class="slider-value">Normal</span></span>
                    </div>
                    <input type="range" id="ef" min="20" max="80" value="55" step="1">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>Smoking Status: <span id="smoking-val" class="slider-value">Former</span></span>
                        <span>Risk: <span id="smoking-risk" class="slider-value">Medium</span></span>
                    </div>
                    <input type="range" id="smoking" min="0" max="2" value="1" step="1">
                </div>

                <div class="explanation">
                    Adjust sliders to simulate different patient profiles. Visualizations update in real-time.
                </div>
            </div>

            <div class="section">
                <div class="section-title">üßæ AI Explanation</div>
                <div id="ai-explanation" class="explanation">
                    The highlighted coronary arteries show increased circulatory risk due to elevated LDL cholesterol (160 mg/dL). Chamber function appears normal with 55% ejection fraction. Blood pressure of 135 mmHg contributes to moderate overall stress.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Three.js
        const container = document.getElementById('viewer');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0c0c2e);
        
        const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 0, 15);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);
        
        // Enhanced lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 10);
        scene.add(directionalLight);
        
        const pointLight = new THREE.PointLight(0x4fc3f7, 1, 100);
        pointLight.position.set(0, 0, 20);
        scene.add(pointLight);
        
        // Data model
        const patientData = {
            age: 55,
            systolicBP: 135,
            diastolicBP: 85,
            ldl: 160,
            hdl: 45,
            triglycerides: 150,
            hba1c: 6.2,
            smoking: 1, // 0=Never, 1=Former, 2=Current
            ejectionFraction: 55,
            wallMotionAbnormality: 0,
            calciumScore: 120,
            stDepression: 0.5,
            hrv: 25,
            troponin: 0.01,
            crp: 3.2,
            bnp: 100,
            familyHistory: 1,
            bmi: 28
        };
        
        // Visualization state
        const visualizationState = {
            activeLayers: new Set(['global']),
            riskScore: 0.42,
            heartBeatPhase: 0,
            hoveredObject: null,
            chamberContraction: {
                leftVentricle: 1.0,
                rightVentricle: 1.0,
                leftAtrium: 1.0,
                rightAtrium: 1.0
            }
        };
        
        // Heart model components
        const heartComponents = {
            chambers: {},
            arteries: {},
            veins: {},
            coronaries: {},
            electrical: {}
        };
        
        // Material definitions
        const materials = {
            normal: new THREE.MeshPhongMaterial({ 
                color: 0xc62828, 
                shininess: 30,
                transparent: true,
                opacity: 0.9
            }),
            stressed: new THREE.MeshPhongMaterial({ 
                color: 0xd32f2f, 
                shininess: 20,
                emissive: 0x441111,
                transparent: true,
                opacity: 0.85
            }),
            highRisk: new THREE.MeshPhongMaterial({ 
                color: 0xb71c1c, 
                shininess: 10,
                emissive: 0x662222,
                transparent: true,
                opacity: 0.8
            }),
            coronaryNormal: new THREE.MeshPhongMaterial({
                color: 0xff5252,
                shininess: 60,
                transparent: true,
                opacity: 0.7
            }),
            coronaryRisky: new THREE.MeshPhongMaterial({
                color: 0xff9800,
                shininess: 40,
                emissive: 0x442200,
                transparent: true,
                opacity: 0.8
            }),
            coronaryHighRisk: new THREE.MeshPhongMaterial({
                color: 0xff5722,
                shininess: 30,
                emissive: 0x662200,
                transparent: true,
                opacity: 0.9
            }),
            electricalNormal: new THREE.MeshPhongMaterial({
                color: 0x4fc3f7,
                shininess: 90,
                emissive: 0x0044aa,
                transparent: true,
                opacity: 0.6
            }),
            electricalAbnormal: new THREE.MeshPhongMaterial({
                color: 0xbb86fc,
                shininess: 80,
                emissive: 0x4400aa,
                transparent: true,
                opacity: 0.7
            })
        };
        
        // Create heart model
        function createHeartModel() {
            const heartGroup = new THREE.Group();
            
            // Left Ventricle
            const leftVentricle = new THREE.Mesh(
                new THREE.SphereGeometry(2.5, 32, 32),
                materials.normal.clone()
            );
            leftVentricle.scale.set(1, 1.3, 0.9);
            leftVentricle.position.set(-1, -1.5, 0);
            leftVentricle.userData = {
                type: 'chamber',
                name: 'Left Ventricle',
                description: 'Main pumping chamber, pumps oxygenated blood to the body'
            };
            heartComponents.chambers.leftVentricle = leftVentricle;
            heartGroup.add(leftVentricle);
            
            // Right Ventricle
            const rightVentricle = new THREE.Mesh(
                new THREE.SphereGeometry(2, 32, 32),
                materials.normal.clone()
            );
            rightVentricle.scale.set(1, 1.2, 0.85);
            rightVentricle.position.set(1.2, -1.3, 0.3);
            rightVentricle.userData = {
                type: 'chamber',
                name: 'Right Ventricle',
                description: 'Pumps deoxygenated blood to the lungs'
            };
            heartComponents.chambers.rightVentricle = rightVentricle;
            heartGroup.add(rightVentricle);
            
            // Left Atrium
            const leftAtrium = new THREE.Mesh(
                new THREE.SphereGeometry(1.5, 32, 32),
                materials.normal.clone()
            );
            leftAtrium.position.set(-1.5, 1, -0.5);
            leftAtrium.userData = {
                type: 'chamber',
                name: 'Left Atrium',
                description: 'Receives oxygenated blood from lungs'
            };
            heartComponents.chambers.leftAtrium = leftAtrium;
            heartGroup.add(leftAtrium);
            
            // Right Atrium
            const rightAtrium = new THREE.Mesh(
                new THREE.SphereGeometry(1.3, 32, 32),
                materials.normal.clone()
            );
            rightAtrium.position.set(1.5, 1, 0);
            rightAtrium.userData = {
                type: 'chamber',
                name: 'Right Atrium',
                description: 'Receives deoxygenated blood from body'
            };
            heartComponents.chambers.rightAtrium = rightAtrium;
            heartGroup.add(rightAtrium);
            
            // Aorta
            const aorta = new THREE.Mesh(
                new THREE.CylinderGeometry(0.6, 0.5, 4, 16),
                new THREE.MeshPhongMaterial({ color: 0xff4444, shininess: 50 })
            );
            aorta.position.set(-1, 2.5, -0.3);
            aorta.rotation.z = 0.3;
            aorta.userData = {
                type: 'vessel',
                name: 'Aorta',
                description: 'Main artery carrying oxygenated blood from left ventricle'
            };
            heartComponents.arteries.aorta = aorta;
            heartGroup.add(aorta);
            
            // Coronary Arteries
            createCoronaryArteries(heartGroup);
            
            // Electrical conduction system (visual abstraction)
            createElectricalSystem(heartGroup);
            
            return heartGroup;
        }
        
        function createCoronaryArteries(parent) {
            // Left Anterior Descending (LAD)
            const ladPath = new THREE.CatmullRomCurve3([
                new THREE.Vector3(-1, 1, 1),
                new THREE.Vector3(-2, 0, 1.5),
                new THREE.Vector3(-2.5, -1, 1),
                new THREE.Vector3(-2, -2, 0.5)
            ]);
            const lad = new THREE.Mesh(
                new THREE.TubeGeometry(ladPath, 20, 0.15, 8, false),
                materials.coronaryNormal.clone()
            );
            lad.userData = {
                type: 'coronary',
                name: 'Left Anterior Descending Artery',
                description: 'Supplies blood to anterior wall of left ventricle'
            };
            heartComponents.coronaries.lad = lad;
            parent.add(lad);
            
            // Right Coronary Artery (RCA)
            const rcaPath = new THREE.CatmullRomCurve3([
                new THREE.Vector3(1, 1, 1),
                new THREE.Vector3(2, 0, 1.2),
                new THREE.Vector3(2.3, -1, 0.8),
                new THREE.Vector3(1.5, -2, 0.3)
            ]);
            const rca = new THREE.Mesh(
                new THREE.TubeGeometry(rcaPath, 20, 0.15, 8, false),
                materials.coronaryNormal.clone()
            );
            rca.userData = {
                type: 'coronary',
                name: 'Right Coronary Artery',
                description: 'Supplies blood to right ventricle and inferior wall'
            };
            heartComponents.coronaries.rca = rca;
            parent.add(rca);
            
            // Circumflex Artery
            const circPath = new THREE.CatmullRomCurve3([
                new THREE.Vector3(-1.5, 0.5, 0),
                new THREE.Vector3(-2.5, 0, 0),
                new THREE.Vector3(-3, -0.5, 0),
                new THREE.Vector3(-2.5, -1, 0)
            ]);
            const circ = new THREE.Mesh(
                new THREE.TubeGeometry(circPath, 16, 0.12, 8, false),
                materials.coronaryNormal.clone()
            );
            circ.userData = {
                type: 'coronary',
                name: 'Circumflex Artery',
                description: 'Supplies blood to lateral wall of left ventricle'
            };
            heartComponents.coronaries.circ = circ;
            parent.add(circ);
        }
        
        function createElectricalSystem(parent) {
            // SA Node
            const saNode = new THREE.Mesh(
                new THREE.SphereGeometry(0.15, 16, 16),
                materials.electricalNormal.clone()
            );
            saNode.position.set(0, 2, 0);
            saNode.userData = {
                type: 'electrical',
                name: 'Sinoatrial Node',
                description: 'Natural pacemaker, initiates heartbeat'
            };
            heartComponents.electrical.saNode = saNode;
            parent.add(saNode);
            
            // AV Node
            const avNode = new THREE.Mesh(
                new THREE.SphereGeometry(0.12, 16, 16),
                materials.electricalNormal.clone()
            );
            avNode.position.set(0, 0, 0.5);
            avNode.userData = {
                type: 'electrical',
                name: 'Atrioventricular Node',
                description: 'Delays impulse to allow ventricular filling'
            };
            heartComponents.electrical.avNode = avNode;
            parent.add(avNode);
            
            // Bundle of His
            const bundlePath = new THREE.CatmullRomCurve3([
                new THREE.Vector3(0, 0, 0.5),
                new THREE.Vector3(0, -1, 0.5),
                new THREE.Vector3(0, -2, 0.3)
            ]);
            const bundle = new THREE.Mesh(
                new THREE.TubeGeometry(bundlePath, 12, 0.08, 8, false),
                materials.electricalNormal.clone()
            );
            bundle.userData = {
                type: 'electrical',
                name: 'Bundle of His',
                description: 'Conducts electrical impulse to ventricles'
            };
            heartComponents.electrical.bundle = bundle;
            parent.add(bundle);
        }
        
        // Calculate risk scores
        function calculateRiskScores() {
            let score = 0;
            
            // Age contribution (10-30%)
            const ageRisk = Math.min((patientData.age - 30) / 60, 1) * 0.3;
            
            // Blood pressure contribution (10-25%)
            const bpRisk = patientData.systolicBP > 140 ? 0.25 : 
                          patientData.systolicBP > 130 ? 0.15 : 
                          patientData.systolicBP > 120 ? 0.1 : 0.05;
            
            // Cholesterol contribution (10-25%)
            const ldlRisk = patientData.ldl > 190 ? 0.25 :
                           patientData.ldl > 160 ? 0.2 :
                           patientData.ldl > 130 ? 0.15 :
                           patientData.ldl > 100 ? 0.1 : 0.05;
            
            // Smoking contribution (5-20%)
            const smokingRisk = patientData.smoking === 2 ? 0.2 :
                               patientData.smoking === 1 ? 0.1 : 0.05;
            
            // EF contribution (5-15%)
            const efRisk = patientData.ejectionFraction < 40 ? 0.15 :
                          patientData.ejectionFraction < 50 ? 0.1 : 0.05;
            
            // Calcium score (5-20%)
            const calciumRisk = Math.min(patientData.calciumScore / 400, 1) * 0.2;
            
            score = ageRisk + bpRisk + ldlRisk + smokingRisk + efRisk + calciumRisk;
            score = Math.min(Math.max(score, 0), 1);
            
            visualizationState.riskScore = score;
            
            // Update UI
            document.getElementById('risk-value').textContent = score.toFixed(2);
            const riskLevel = document.getElementById('risk-level');
            
            if (score < 0.3) {
                riskLevel.textContent = 'LOW RISK';
                riskLevel.style.background = 'rgba(76, 175, 80, 0.2)';
                riskLevel.style.color = '#4caf50';
            } else if (score < 0.6) {
                riskLevel.textContent = 'MODERATE RISK';
                riskLevel.style.background = 'rgba(255, 152, 0, 0.2)';
                riskLevel.style.color = '#ff9800';
            } else {
                riskLevel.textContent = 'HIGH RISK';
                riskLevel.style.background = 'rgba(239, 83, 80, 0.2)';
                riskLevel.style.color = '#ef5350';
            }
            
            return score;
        }
        
        // Update visualization based on risk scores
        function updateVisualization() {
            const riskScore = visualizationState.riskScore;
            
            // LAYER 1: Global Risk State
            if (visualizationState.activeLayers.has('global') || visualizationState.activeLayers.has('all')) {
                let heartColor, emissiveIntensity, pulseAmplitude;
                
                if (riskScore < 0.3) {
                    // Low risk
                    heartColor = new THREE.Color(0xc62828);
                    emissiveIntensity = 0;
                    pulseAmplitude = 0.05;
                } else if (riskScore < 0.6) {
                    // Moderate risk
                    heartColor = new THREE.Color(0xd32f2f);
                    emissiveIntensity = 0.1;
                    pulseAmplitude = 0.07;
                } else {
                    // High risk
                    heartColor = new THREE.Color(0xb71c1c);
                    emissiveIntensity = 0.3;
                    pulseAmplitude = 0.1;
                }
                
                // Apply to all chambers
                Object.values(heartComponents.chambers).forEach(chamber => {
                    chamber.material.color = heartColor;
                    chamber.material.emissive = new THREE.Color(emissiveIntensity, 0, 0);
                    chamber.material.needsUpdate = true;
                });
                
                // Store pulse amplitude for animation
                visualizationState.pulseAmplitude = pulseAmplitude;
            }
            
            // LAYER 2: Chamber Function
            if (visualizationState.activeLayers.has('chamber') || visualizationState.activeLayers.has('all')) {
                const ef = patientData.ejectionFraction;
                const wallMotionAbnormal = patientData.wallMotionAbnormality;
                
                // Calculate contraction strength
                const contractionStrength = ef / 65; // Normalize to 65% EF
                
                // Update chamber scales for contraction animation
                visualizationState.chamberContraction.leftVentricle = 
                    0.9 + contractionStrength * 0.2;
                visualizationState.chamberContraction.rightVentricle = 
                    0.9 + contractionStrength * 0.15;
                
                // Dim affected chamber if wall motion abnormality
                if (wallMotionAbnormal) {
                    heartComponents.chambers.leftVentricle.material.opacity = 0.6;
                    heartComponents.chambers.leftVentricle.material.emissive = new THREE.Color(0.2, 0, 0);
                } else {
                    heartComponents.chambers.leftVentricle.material.opacity = 0.9;
                }
            }
            
            // LAYER 3: Coronary Vasculature
            if (visualizationState.activeLayers.has('coronary') || visualizationState.activeLayers.has('all')) {
                const ldl = patientData.ldl;
                const calcium = patientData.calciumScore;
                const smoking = patientData.smoking;
                
                let coronaryColor, emissiveStrength, flowSpeed;
                
                if (ldl > 160 || calcium > 100) {
                    // High risk
                    coronaryColor = new THREE.Color(0xff5722);
                    emissiveStrength = 0.4;
                    flowSpeed = smoking === 2 ? 0.5 : 0.7;
                } else if (ldl > 130 || calcium > 50) {
                    // Moderate risk
                    coronaryColor = new THREE.Color(0xff9800);
                    emissiveStrength = 0.2;
                    flowSpeed = smoking === 2 ? 0.6 : 0.8;
                } else {
                    // Normal
                    coronaryColor = new THREE.Color(0xff5252);
                    emissiveStrength = 0;
                    flowSpeed = 1.0;
                }
                
                // Apply to coronary arteries
                Object.values(heartComponents.coronaries).forEach(artery => {
                    artery.material.color = coronaryColor;
                    artery.material.emissive = new THREE.Color(emissiveStrength * 0.5, 0, 0);
                    artery.material.needsUpdate = true;
                });
                
                // Store flow speed for animation
                visualizationState.coronaryFlowSpeed = flowSpeed;
            }
            
            // LAYER 4: Electrical System
            if (visualizationState.activeLayers.has('electrical') || visualizationState.activeLayers.has('all')) {
                const stDepression = patientData.stDepression;
                const hrv = patientData.hrv;
                
                let electricalColor, pulseRegularity;
                
                if (stDepression > 1 || hrv < 20) {
                    // Abnormal
                    electricalColor = new THREE.Color(0xbb86fc);
                    pulseRegularity = 0.3;
                } else {
                    // Normal
                    electricalColor = new THREE.Color(0x4fc3f7);
                    pulseRegularity = 1.0;
                }
                
                // Apply to electrical system
                Object.values(heartComponents.electrical).forEach(component => {
                    component.material.color = electricalColor;
                    component.material.needsUpdate = true;
                });
                
                visualizationState.electricalPulseRegularity = pulseRegularity;
            }
            
            // LAYER 5: Biochemical Stress
            if (visualizationState.activeLayers.has('biochemical') || visualizationState.activeLayers.has('all')) {
                const troponin = patientData.troponin;
                const crp = patientData.crp;
                const bnp = patientData.bnp;
                
                // Create biochemical markers if needed
                if (troponin > 0.04) {
                    createBiochemicalMarker('troponin', new THREE.Vector3(-1, -2, 1));
                }
                
                // Adjust overall haze based on CRP
                if (crp > 3) {
                    const hazeIntensity = Math.min((crp - 3) / 10, 0.3);
                    scene.fog = new THREE.Fog(0xb71c1c, 15, 25);
                    scene.fog.density = hazeIntensity;
                } else {
                    scene.fog = null;
                }
                
                // Chamber strain indicators for BNP
                if (bnp > 100) {
                    heartComponents.chambers.leftVentricle.material.emissive.g = 0.2;
                }
            }
            
            // Update AI explanation
            updateAIExplanation();
        }
        
        function createBiochemicalMarker(type, position) {
            const marker = new THREE.Mesh(
                new THREE.SphereGeometry(0.1, 8, 8),
                new THREE.MeshBasicMaterial({ color: 0xff0000 })
            );
            marker.position.copy(position);
            marker.userData = {
                type: 'biomarker',
                name: 'Troponin Elevation',
                description: 'Marker of myocardial stress or injury'
            };
            scene.add(marker);
            
            // Animate marker
            marker.scale.set(1.5, 1.5, 1.5);
            setTimeout(() => scene.remove(marker), 2000);
        }
        
        function updateAIExplanation() {
            const explanations = [];
            
            if (visualizationState.activeLayers.has('global') || visualizationState.activeLayers.has('all')) {
                const riskLevel = visualizationState.riskScore < 0.3 ? 'low' : 
                                 visualizationState.riskScore < 0.6 ? 'moderate' : 'high';
                explanations.push(`Overall cardiovascular risk is ${riskLevel} (score: ${visualizationState.riskScore.toFixed(2)}).`);
            }
            
            if (visualizationState.activeLayers.has('coronary') || visualizationState.activeLayers.has('all')) {
                if (patientData.ldl > 160) {
                    explanations.push(`Elevated LDL cholesterol (${patientData.ldl} mg/dL) increases coronary artery disease risk.`);
                }
                if (patientData.calciumScore > 100) {
                    explanations.push(`Coronary calcium score of ${patientData.calciumScore} indicates plaque buildup.`);
                }
            }
            
            if (visualizationState.activeLayers.has('chamber') || visualizationState.activeLayers.has('all')) {
                if (patientData.ejectionFraction < 50) {
                    explanations.push(`Reduced ejection fraction (${patientData.ejectionFraction}%) suggests impaired pumping function.`);
                }
            }
            
            if (explanations.length === 0) {
                explanations.push("Adjust parameters to see real-time visualization changes.");
            }
            
            document.getElementById('ai-explanation').textContent = explanations.join(' ');
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Update heartbeat phase
            visualizationState.heartBeatPhase += 0.05 * (patientData.hrv / 50 || 1);
            
            // Apply pulsation to entire heart
            const pulse = 1 + Math.sin(visualizationState.heartBeatPhase) * 
                         (visualizationState.pulseAmplitude || 0.05);
            
            scene.traverse(obj => {
                if (obj.userData && obj.userData.type) {
                    // Chamber-specific contraction
                    if (obj.userData.type === 'chamber') {
                        let chamberScale = 1;
                        if (obj.userData.name === 'Left Ventricle') {
                            chamberScale = visualizationState.chamberContraction.leftVentricle || 1;
                        } else if (obj.userData.name === 'Right Ventricle') {
                            chamberScale = visualizationState.chamberContraction.rightVentricle || 1;
                        }
                        obj.scale.setScalar(pulse * chamberScale);
                    }
                    
                    // Coronary artery pulsation
                    if (obj.userData.type === 'coronary') {
                        const flowSpeed = visualizationState.coronaryFlowSpeed || 1;
                        obj.material.opacity = 0.6 + 0.3 * Math.sin(visualizationState.heartBeatPhase * flowSpeed);
                    }
                    
                    // Electrical system pulsation
                    if (obj.userData.type === 'electrical') {
                        const regularity = visualizationState.electricalPulseRegularity || 1;
                        const pulse = 0.8 + 0.4 * Math.sin(visualizationState.heartBeatPhase * regularity);
                        obj.scale.setScalar(pulse);
                    }
                }
            });
            
            // Auto-rotate when not interacting
            if (!visualizationState.isDragging) {
                scene.rotation.y += 0.001;
            }
            
            renderer.render(scene, camera);
        }
        
        // Event handlers
        function setupEventHandlers() {
            // Layer control buttons
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const layer = btn.dataset.layer;
                    
                    if (layer === 'all') {
                        visualizationState.activeLayers = new Set(['global', 'chamber', 'coronary', 'electrical', 'biochemical']);
                    } else {
                        if (visualizationState.activeLayers.has(layer)) {
                            visualizationState.activeLayers.delete(layer);
                            btn.classList.remove('active');
                        } else {
                            visualizationState.activeLayers.add(layer);
                            btn.classList.add('active');
                        }
                    }
                    
                    // Update layer explanation
                    const explanations = {
                        global: "Global Risk Layer: Shows overall cardiovascular stress level through heart coloration and pulsation patterns.",
                        chamber: "Chamber Function Layer: Displays pumping efficiency and wall motion abnormalities through contraction strength and chamber opacity.",
                        coronary: "Coronary Vasculature Layer: Visualizes circulatory risk through artery coloration and flow animation speed.",
                        electrical: "Electrical System Layer: Shows electrical stability through conduction pathway colors and pulse regularity.",
                        biochemical: "Biochemical Stress Layer: Indicates myocardial stress through inflammatory markers and chamber strain indicators."
                    };
                    
                    document.getElementById('layer-explanation').textContent = 
                        explanations[layer] || "Multiple layers active. Each layer shows different physiological aspects of cardiovascular risk.";
                    
                    updateVisualization();
                });
            });
            
            // Slider controls
            document.getElementById('age').addEventListener('input', (e) => {
                patientData.age = parseInt(e.target.value);
                document.getElementById('age-val').textContent = patientData.age;
                document.getElementById('age-risk').textContent = 
                    patientData.age > 65 ? 'High' : patientData.age > 50 ? 'Medium' : 'Low';
                calculateRiskScores();
                updateVisualization();
            });
            
            document.getElementById('bp').addEventListener('input', (e) => {
                patientData.systolicBP = parseInt(e.target.value);
                document.getElementById('bp-val').textContent = patientData.systolicBP;
                document.getElementById('bp-risk').textContent = 
                    patientData.systolicBP > 140 ? 'High' : 
                    patientData.systolicBP > 130 ? 'Medium' : 'Low';
                calculateRiskScores();
                updateVisualization();
            });
            
            document.getElementById('ldl').addEventListener('input', (e) => {
                patientData.ldl = parseInt(e.target.value);
                document.getElementById('ldl-val').textContent = patientData.ldl;
                document.getElementById('ldl-risk').textContent = 
                    patientData.ldl > 190 ? 'Very High' :
                    patientData.ldl > 160 ? 'High' :
                    patientData.ldl > 130 ? 'Borderline' : 'Optimal';
                calculateRiskScores();
                updateVisualization();
            });
            
            document.getElementById('ef').addEventListener('input', (e) => {
                patientData.ejectionFraction = parseInt(e.target.value);
                document.getElementById('ef-val').textContent = patientData.ejectionFraction;
                document.getElementById('ef-risk').textContent = 
                    patientData.ejectionFraction < 40 ? 'Low' :
                    patientData.ejectionFraction < 50 ? 'Reduced' : 'Normal';
                calculateRiskScores();
                updateVisualization();
            });
            
            document.getElementById('smoking').addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                patientData.smoking = val;
                const status = ['Never', 'Former', 'Current'][val];
                document.getElementById('smoking-val').textContent = status;
                document.getElementById('smoking-risk').textContent = 
                    val === 2 ? 'High' : val === 1 ? 'Medium' : 'Low';
                calculateRiskScores();
                updateVisualization();
            });
            
            // Mouse controls for 3D view
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            renderer.domElement.addEventListener('mousedown', (e) => {
                isDragging = true;
                visualizationState.isDragging = true;
            });
            
            renderer.domElement.addEventListener('mousemove', (e) => {
                const rect = renderer.domElement.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Hover detection
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                mouse.x = (x / rect.width) * 2 - 1;
                mouse.y = -(y / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children, true);
                
                if (intersects.length > 0) {
                    const obj = intersects[0].object;
                    if (obj.userData && obj.userData.name) {
                        visualizationState.hoveredObject = obj;
                        const tooltip = document.getElementById('hover-tooltip');
                        tooltip.style.display = 'block';
                        tooltip.style.left = (e.clientX + 10) + 'px';
                        tooltip.style.top = (e.clientY + 10) + 'px';
                        tooltip.innerHTML = `
                            <strong>${obj.userData.name}</strong><br>
                            <em>${obj.userData.type}</em><br>
                            ${obj.userData.description}
                        `;
                    }
                } else {
                    document.getElementById('hover-tooltip').style.display = 'none';
                    visualizationState.hoveredObject = null;
                }
                
                // Rotation
                if (isDragging) {
                    const deltaMove = {
                        x: e.clientX - previousMousePosition.x,
                        y: e.clientY - previousMousePosition.y
                    };
                    
                    scene.rotation.y += deltaMove.x * 0.01;
                    scene.rotation.x += deltaMove.y * 0.01;
                }
                
                previousMousePosition = {
                    x: e.clientX,
                    y: e.clientY
                };
            });
            
            renderer.domElement.addEventListener('mouseup', () => {
                isDragging = false;
                visualizationState.isDragging = false;
            });
            
            // Zoom with scroll wheel
            renderer.domElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(5, Math.min(30, camera.position.z));
            });
            
            // Window resize
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }
        
        // Initialize the application
        function init() {
            const heart = createHeartModel();
            scene.add(heart);
            
            calculateRiskScores();
            updateVisualization();
            setupEventHandlers();
            animate();
        }
        
        // Start the application
        init();
    </script>
</body>
</html>